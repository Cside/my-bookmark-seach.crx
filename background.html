<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
  </head>
  <script>
function c (s) { console.log(s) }
function a (s) { alert(s) }

var INDEX = [];
var lastQuery;
function onInputChangedListener (query, suggest) {
    if (lastQuery == query || query.length == 0) return;
    lastQuery = query;

    var suggests = [];
    for (var i = 0; i < INDEX.length; i++) {
        var index   = INDEX[i];
        var title   = index[0];
            title   = title.replace(/[<>&"']/g, '')
          //title   = truncate(title, 64);
        var comment = index[1];
        var url     = index[2];
        var match   = 0;
        query.split(/\s/).forEach(function (q) {
            var re = new RegExp(q.replace(/\W/g, '\\$&'), 'ig');
            if ((title + comment + url).match(re)) {
                title = title.replace(re, '<match>$&</match>');
                match++
            }
        });
        if (query.split(/\s/).length === match) {
            suggests.push({
                content:     url,
                description: title + ' <url>' + url + '</url>',
            });
        }
        if (suggests.length >= 5) break;
    }
    suggest(suggests);
}

function setupOnInputListener () {
    chrome.omnibox.setDefaultSuggestion({
        description: 'Search my bookmarks for <match>%s</match>'
    });

    chrome.omnibox.onInputChanged.addListener(onInputChangedListener);

    chrome.omnibox.onInputEntered.addListener(
        function(text) {
            if (text.match(/^http:/)) {
                chrome.tabs.getSelected(null, function (tab) {
                    chrome.tabs.update(tab.id, { url: text });
                });
            }
        }
    );
}

chrome.omnibox.onInputStarted.addListener(
    function () {
        // make index
        var req = new XMLHttpRequest();
        req.open('GET', 'http://b.hatena.ne.jp/my/search.data', true);
        req.onreadystatechange = function (e) {
            if (req.readyState == 4) {
                if (req.status == 200) {
                    var lines = req.responseText.split(/\n/);
                    var index = [];
                    for (var i = 0; i < lines.length; i++) {
                        var line = lines[i];
                        if (line.match(/^[\d]+\t[\d]+\n?$/)) break;

                        index[i % 3] = line;
                        if (i % 3 === 2) {
                            INDEX.push(index);
                            index = [];
                        }
                    }
                    setupOnInputListener();
                    
                } else {
                    console.log(e);
                }
            }
        };
        req.send(null);
    }
);

// Utils
function truncate(str, size, suffix) {
    if (!str)    str = '';
    if (!size)   size = 32;
    if (!suffix) suffix = '...';
    var b = 0;
    for (var i = 0;  i < str.length; i++) {
        b += str.charCodeAt(i) <= 255 ? 1 : 2;
        if (b > size) {
            return str.substr(0, i) + suffix;
        }
    }
    return str;
}

  </script>
</html>
